/* Copyright (c) Ericsson 2015 */

define("3pps/bpmn/Transformer",[],function(){function e(e){var t;if(e instanceof Document)t=e;else if(window.DOMParser){var n=new DOMParser;t=n.parseFromString(e,"text/xml")}else t=new ActiveXObject("Microsoft.XMLDOM"),t.async=!1,t.loadXML(e);return t}function t(){this.parseListeners=[]}function n(e){return new Error(e)}var i="http://www.omg.org/spec/BPMN/20100524/MODEL",a="http://www.omg.org/spec/BPMN/20100524/DI";return t.prototype.transform=function(t){function r(e,t,n){function a(e,t){for(var n=0;n<e.childNodes.length;n++)if(e.childNodes[n].localName==t)return e.childNodes[n]}var r={};t&&t.baseElements.push(r);var o=e.attributes;r.type=e.localName;for(var s=0;null!=o&&s<o.length;s++){var l=o[s];r[l.nodeName]=l.nodeValue}if("textAnnotation"==r.type){var u=e.getElementsByTagNameNS(i,"text")[0].firstChild.data;r.text=u}var f=n[r.id];f&&(r.bpmndi=f),r.id||(r.id=r.type+"_"+C,C++);var c=a(e,"multiInstanceLoopCharacteristics"),d=a(e,"standardLoopCharacteristics");return r.marker={},c&&"true"===c.getAttribute("isSequential")?r.marker.multiInstanceSequential=!0:c&&(r.marker.multiInstanceParallel=!0),d&&(r.marker.loop=!0),"true"==r.isForCompensation&&(r.marker.compensation=!0),r}function o(e,t,i,a){var o=r(e,t,a);o.outgoing=[],o.listeners=[],o.properties={};e.attributes;if(i){var s=i[o.id];if(s){for(var l=0;l<s.length;l++)o.outgoing.push(s[l].id);if(o["default"]&&A){for(var u=!1,l=0;l<s.length;l++){var f=s[l];if(f.condition){if(o.defaultFlowId==f.id)throw n("Sequence flow with id '"+f.id+"' is configured to be the default flow but has a condition");u=!0}}if(!u)throw n("Activity with id '"+o.id+"' declares default flow with id '"+o["default"]+"' but has no conditional flows.")}}}return o}function s(e,t,n,i){var a=o(e,t,n,i);return a}function l(e,t,n){for(var a=r(e,t,n),o=e.getElementsByTagNameNS(i,"dataInput"),s=e.getElementsByTagNameNS(i,"dataOutput"),l=[],u=0;u<o.length;u++)l.push(r(o[u],t,n));for(var u=0;u<s.length;u++)l.push(r(s[u],t,n));return a.baseElements=l,a}function u(e,t,n){if(0!=e.childNodes.length){var i=e.firstChild;do{i.nodeName;r(i,t,n)}while(i=i.nextSibling)}}function f(e,t,n,i){var a=o(e,t,n,i);a.eventDefinitions=[];var r=e.firstChild;if(r)do if(-1!=r.nodeName.indexOf("EventDefinition")){var s=r.nodeName;-1!=s.indexOf(":")&&(s=s.substr(s.indexOf(":")+1,s.length)),a.eventDefinitions.push({type:s})}while(r=r.nextSibling);return a}function c(e,t,n,a){var o=r(e,t,n);o.sourceRef&&(a[o.sourceRef]||(a[o.sourceRef]=[]),a[o.sourceRef].push(o));var s=e.getElementsByTagNameNS(i,"conditionExpression");if(s&&s.length>0){var l=s[0];o.condition=l.textContent}return o.properties={},o}function d(e,t,n){e=e.firstChild;var i={};if(!e)return i;do("sequenceFlow"==e.nodeName||"sequenceFlow"==e.localName)&&c(e,t,n,i);while(e=e.nextSibling);return i}function h(e,t,n,i){var a=o(e,t,n,i),r=0;for(var s in n)for(var l=n[s],u=0;u<l.length;u++)l[u].targetRef==a.id&&r++;return a.cardinality=r,a}function g(e,t,i,a){var r=o(e,t,null,a),s=r.sequenceFlows,l=r["default"];if(i&&A){var s=i[r.id];if(s)if(r.sequenceFlows=s,1==s.length){if(s[0].condition)throw n("If an exclusive Gateway has a single outgoing sequence flow, the sequence flow is not allowed to have a condition.")}else if(s.length>1){for(var u,f=[],c=0;u=s[c];c++){var d=!!u.condition,h=l===u.id;if(d||h||f.push(u),d&&h)throw n("Sequence flow with id '"+u.id+"' is configured to be the default flow but has a condition.")}if(l&&f.length>0||f.length>1)throw n("Exclusive Gateway '"+r.id+"' has outgoing sequence flows without conditions which are not the default flow.");l||1!==f.length||console.log("[Transformer]: Sequence flow with id '"+f[0].id+"' has no conditions but it is not configured to be the default flow.")}}return r}function v(e,t,n,i){for(var a=0;a<M.length;a++){var r=M[a];r(e,t,n,i)}}function m(e,t,n){t.baseElements=[];var i=d(e,t,n),a=e.firstChild;if(a)do{var o=null,c=a.nodeName;-1!=c.indexOf(":")&&(c=c.substr(c.indexOf(":")+1,c.length));var m=["callActivity","task","manualTask","serviceTask","scriptTask","userTask","sendTask","recieveTask","businessRuleTask"],p=["startEvent","endEvent","intermediateThrowEvent","intermediateCatchEvent","boundaryEvent"];"exclusiveGateway"==c?o=g(a,t,i,n):"parallelGateway"==c?o=h(a,t,i,n):-1!=m.indexOf(c)?o=s(a,t,i,n):-1!=p.indexOf(c)?o=f(a,t,i,n):"laneSet"==c?o=u(a,t,n):"subProcess"==c||"adHocSubProcess"==c||"transaction"==c?o=w(a,t,i,n):"ioSpecification"==c?o=l(a,t,n):a&&"sequenceFlow"!=a.nodeName&&1==a.nodeType&&(o=r(a,t,n)),o&&v(o,a,t,e)}while(a=a.nextSibling)}function p(e,t){var n=o(e,null,null,t);A=n.isExecutable?"true"==n.isExecutable:!1,m(e,n,t),q.push(n),v(n,e)}function w(e,t,n,i){var a=o(e,t,n,i);m(e,a,i),v(a,e)}function N(e,t){var n={};n.type=e.localName;for(var i=0;null!=e.attributes&&i<e.attributes.length;i++){var a=e.attributes.item(i);"bpmnElement"!=a.nodeName&&(n[a.nodeName]=a.nodeValue)}var r=[],o=e.firstChild;if(o)do N(o,r);while(o=o.nextSibling);r.length>0&&(n.children=r),t.push(n)}function b(e,t){var n;e.namespaceURI&&e.namespaceURI==a&&(n=e.getAttribute("bpmnElement"));var i=e.firstChild;if(i)do if("BPMNDiagram"==e.localName||"BPMNPlane"==e.localName)b(i,t);else{var r=[];N(e,r),t[n]=r}while(i=i.nextSibling)}function y(e,t){for(var n,a=[],o=e.getElementsByTagNameNS(i,"messageFlow"),s=0;n=o[s];s++){var l=r(n,null,t);a.push(l)}return a}function E(e,t){for(var n=[],a=e.getElementsByTagNameNS(i,"participant"),o=0;o<a.length;o++){var s=r(a[o],null,t);n.push(s)}return n}function S(e){var t=[],n=e.getElementsByTagNameNS(i,"categoryValue");if(0!=n.length)for(var a=0;a<n.length;a++){var o=r(n[a],null,[]);t.push(o)}return t}function x(e,t){for(var n,a=[],o=e.getElementsByTagNameNS(i,"dataInputAssociation"),s=e.getElementsByTagNameNS(i,"dataOutputAssociation"),l=0;n=o[l];l++)a.push(r(n,null,t));for(var u,f=0;u=s[f];f++)a.push(r(u,null,t));return a}function T(e,t){for(var n=[],a=e.getElementsByTagNameNS(i,"message"),o=0;o<a.length;o++){var s=r(a[o],null,t);n.push(s)}return n}function B(e){for(var t=e.getElementsByTagNameNS(a,"BPMNDiagram"),n={},r=0;r<t.length;r++)b(t[r],n);var o=e.getElementsByTagNameNS(i,"process"),s={},l=E(e,n),u=S(e);q=u.concat(q.concat(l));for(var f,c=0;f=l[c];c++)f.processRef&&(n[f.processRef]=n[f.id],s[f.processRef]=f.name);for(var d,h=0;d=o[h];h++){var g=s[d.getAttribute("id")];g&&d.setAttributeNS(i,"name",s[d.getAttribute("id")]),p(d,n)}var v=y(e,n),m=x(e,n),w=T(e,n);return q.concat(v,m,w)}var M=this.parseListeners,O=e(t),k=O.getElementsByTagNameNS(i,"definitions");if(0==k.length)throw n("A BPMN 2.0 XML file must contain at least one definitions element");var q=[],A=!1,C=0;return B(k[0])},t});