/* Copyright (c) Ericsson 2015 */

define("3pps/wfs/WfUsertaskClient",["jscore/core","jscore/ext/mvp","jscore/ext/net","3pps/wfs/WfClientCommon"],function(e,s,t,r){var c={};return c.getUsertasks=function(e){if(e=e||{},null==e.success)throw new Error("success callback missing");var t="/engine-rest/engine/default/task";if(null!=e.sortBy){if(-1==["name","created"].indexOf(e.sortBy))throw new Error("Invalid sortBy value: "+sortBy);if(t+="?orderBy="+e.sortBy,null!=e.sortOrder){if(-1==["asc","desc"].indexOf(e.sortOrder))throw new Error("Invalid sortOrder value: "+sortOrder);t+="&order="+e.sortOrder}}null!=e.offset&&(t+="&offset="+e.offset),null!=e.limit&&(t+="&limit="+e.limit),null!=e.active&&(t+="&active="+e.active),null!=e.suspended&&(t+="&suspended="+e.suspended);var r=new s.Collection([],{url:t});r.fetch({success:function(s){e.success.call(this,s)},error:function(e,s,t){t.error&&t.error.call(this,s)}})},c.getUsertasksCount=function(e){if(e=e||{},null==e.success)throw new Error("success callback missing");var t="/WorkflowService/oss/rest/services/wfs/default/usertasks/count",r=new s.Collection([],{url:t});r.fetch({success:function(s){var t=s._collection.models[0].getAttribute("count");e.success.call(this,t)},error:function(e,s,t){t.error&&t.error.call(this,s)}})},c.getFormModelByUsertaskId=function(e){if(e=e||{},null==e.success)throw new Error("success callback missing");if(null==e.usertaskId||""==e.usertaskId)throw new Error("usertaskId missing");var c="/engine-rest/engine/default/task/"+e.usertaskId+"/form",o=new s.Model([],{url:c});o.fetch({success:function(c){if(null==c.getAttribute("key"))e.success.call(this,null);else try{var o=c.getAttribute("contextPath"),a=c.getAttribute("key"),i=r.extractFormInfo(a),l=o+"/"+i.path;t.ajax({url:l,type:"GET",dataType:i.format,success:function(t){if("json"==i.format){var r=new s.Model;t.modelType!=i.modelType&&n(e,"Form modelType mismatch, "+t.modelType+"!="+i.modelType),r.setAttribute("formInfo",i),r.setAttribute("submitText",t.submitText),r.setAttribute("cancelText",t.cancelText),r.setAttribute("controlGroups",t.controlGroups),e.success.call(this,r)}else e.success.call(this,t)},error:function(s){n(e,s)}})}catch(u){n(e,u)}},error:function(s){n(e,s)}});var n=function(e,s){e.error&&e.error.call(this,s),console.log(s)}},c.completeUsertaskById=function(e){if(e=e||{},null==e.success)throw new Error("success callback missing");if(null==e.usertaskId||""==e.usertaskId)throw new Error("usertaskId missing");var s="/engine-rest/engine/default/task/"+e.usertaskId+"/complete",r={variables:e.variables};t.ajax({url:s,type:"POST",data:JSON.stringify(r),dataType:"json",contentType:"application/json;charset=UTF-8",processData:!1,success:function(){e.success.call(this)},error:function(s){e.error&&e.error.call(this,s)}})},c.getUsertasksComments=function(e){if(e=e||{},null==e.success)throw new Error("success callback missing");var r="/workflowservice-ext/rest/task-ext/";null!=e.taskId&&(r+=e.taskId,r+="/comments",t.ajax({url:r,type:"GET",dataType:"json",success:function(t){var r=new s.Collection;if(null!=t)for(var c in t){var o=new s.Model;o.setAttribute("id",t[c].id),o.setAttribute("taskId",t[c].taskId),o.setAttribute("userId",t[c].userId),o.setAttribute("createdTime",t[c].createdTime),o.setAttribute("comment",t[c].comment),r.addModel(o)}e.success.call(this,r)},error:function(s){e.error&&e.error.call(this,s)}}))},c.addUsertaskCommentById=function(e){if(e=e||{},null==e.success)throw new Error("success callback missing");if(null==e.taskId||""==e.taskId)throw new Error("usertaskId missing");var s="/workflowservice-ext/rest/task-ext/"+e.taskId,r={id:e.id,taskId:e.taskId,userId:e.userId,createdTime:e.createdTime,comment:e.comment};t.ajax({url:s,type:"POST",data:JSON.stringify(r),dataType:"json",contentType:"application/json;charset=UTF-8",processData:!1,success:function(){e.success.call(this)},error:function(s){e.error&&e.error.call(this,s)}})},c});