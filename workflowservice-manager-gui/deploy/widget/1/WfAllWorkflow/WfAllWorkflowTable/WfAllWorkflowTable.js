/* Copyright (c) Ericsson 2015 */

define("styles!widget/WfAllWorkflow/WfAllWorkflowTable/WfAllWorkflowTable.less",function(){return""}),define("text!widget/WfAllWorkflow/WfAllWorkflowTable/WfAllWorkflowTable.html",function(){return'<div class="eaNFE_automation_UI-WfAllWorkflowTable">\r\n    <div class="eaNFE_automation_UI-WfAllWorkflowTable-contentTable eb_scrollbar"></div>\r\n    <div class="eaNFE_automation_UI-WfAllWorkflowTable-contentTable-Pagination"></div>\r\n</div>\r\n'}),define("widget/WfAllWorkflow/WfAllWorkflowTable/WfAllWorkflowTableView",["jscore/core","text!./WfAllWorkflowTable.html","styles!./WfAllWorkflowTable.less"],function(t,e,i){return t.View.extend({getTemplate:function(){return e},getStyle:function(){return i},getTableContent:function(){return this.getElement().find(".eaNFE_automation_UI-WfAllWorkflowTable-contentTable")},getPagination:function(){return this.getElement().find(".eaNFE_automation_UI-WfAllWorkflowTable-contentTable-Pagination")}})}),define("widget/WfAllWorkflow/WfAllWorkflowTable/WfAllWorkflowTable",["jscore/core","jscore/ext/mvp","./WfAllWorkflowTableView","tablelib/Table","widgets/Pagination","3pps/wfs/WfDefinitionClient","3pps/wfs/WfInstanceClient","3pps/wfs/WfCountsClient","../../WfBarPercentageCell/WfBarPercentageCell","jscore/ext/locationController","widgets/table/Row","../../../widget/WfUsertasks/TaskTable/TaskActionsCell/TaskActionsCell","tablelib/plugins/StickyHeader","tablelib/plugins/StickyScrollbar","tablelib/plugins/Selection","tablelib/plugins/SortableHeader","jscore/ext/locationController"],function(t,e,i,s,n,o,l,r,a,h,c,d,f,w,u,g,h){return t.Widget.extend({View:i,init:function(){this.offset=this.options.offset?this.options.offset:0,this.limit=this.options.limit?this.options.limit:20,this.sortBy=this.options.sortBy?this.options.sortBy:"startTime",this.sortOrder=this.options.sortOrder?this.options.sortOrder:"desc",this.showActive=this.options.showActive,this.showCompleted=this.options.showCompleted,this.hidePercentage=this.options.hidePercentage,this.filter=this.options.filter?this.options.filter:"all"},onViewReady:function(){function t(){this._inContext=!1,this.options.regionEventBus.publish("topsection:leavecontext")}function e(){this._inContext=!0,this.options.regionEventBus.publish("topsection:contextactions",[{type:"link",icon:"tick",flat:!0,name:"View Instance",action:i.bind(this)}])}function i(){this.table.getSelectedRows().forEach(function(t){var e=new h,i="workflowinstancen/"+t.options.model.workflowDefinitionId+"/"+t.options.model.workflowName.match("(\\.\\s)*(.*)")[2]+"/"+t.options.model.shortWorkflowInstanceId+"/"+t.options.model.startTime+"/"+t.options.model.workflowVersion;e.setLocation(i)}.bind(this)),t.call(this)}this.columns=[{title:"Workflow",attribute:"workflowName",width:"400px",sortable:!0},{title:"Version",attribute:"workflowVersion",sortable:!0},{title:"Instance Id",attribute:"shortWorkflowInstanceId",sortable:!0}],this.showActive&&this.columns.push({title:"Start Time",attribute:"startTime",sortable:!0}),this.showCompleted&&this.columns.push({title:"End Time",attribute:"endTime",sortable:!0}),this.table=new s({plugins:[new u({selectableRows:!0,multiselect:!0}),new w,new f({topOffset:34}),new g],selectableRows:!0,modifiers:["striped"],columns:this.columns}),this.renderInstanceTable(this.filter),this.table.addEventHandler("sort",function(t,e){this.table.setData(this.getSortedData(t,e))}.bind(this)),this.table.addEventHandler("rowselectend",function(i){i.length>0&&!this._inContext?e.call(this):0===i.length&&t.call(this)}.bind(this))},getSortedData:function(t,e){return this.tableInstances.sort(e,t),this.tableInstances.toJSON()},renderInstanceTable:function(t){"all"==t?o.getDefinitionNames({success:function(t){this.workflowDefinitions={},t.each(function(t){this.workflowDefinitions[t.getAttribute("id")]=t}.bind(this)),l.getInstances({sortBy:this.sortBy,sortOrder:this.sortOrder,offset:this.offset,limit:this.limit,completed:this.showCompleted,active:this.showActive,success:function(t){this.tableInstances=new e.Collection,t.each(function(t){var i=new e.Model,s=t.getAttribute("definitionId"),n="";this.workflowDefinitions[s]&&(n=this.workflowDefinitions[s].getAttribute("name")),i.setAttribute("workflowName",n),i.setAttribute("workflowVersion",this.workflowDefinitions[s].getAttribute("version")),i.setAttribute("shortWorkflowInstanceId",t.getAttribute("id")),i.setAttribute("workflowInstanceId",t.getAttribute("id")),i.setAttribute("workflowDefinitionId",s),i.setAttribute("startTime",t.getAttribute("startTime")),i.setAttribute("endTime",t.getAttribute("endTime")),i.setAttribute("superProcessInstanceId",t.getAttribute("superProcessInstanceId")),this.tableInstances.addModel(i)}.bind(this)),this.tableInstances=this.arrangeHierarchically(this.tableInstances),this.table.setData(this.tableInstances.toJSON()),this.table.attachTo(this.view.getTableContent())}.bind(this)}),this.highlightedRow=null,this.table.addEventHandler("rowclick",function(t,e){t.isHighlighted()?(t.highlight(!1),this.highlightedRow=null,this.getEventBus().publish("instance-deselected",t.getData().attributes)):(null!=this.highlightedRow&&(this.highlightedRow.highlight(!1),this.getEventBus().publish("instance-deselected",this.highlightedRow.getData().attributes),this.highlightedRow=null),t.highlight(!0),this.highlightedRow=t,this.getEventBus().publish("instance-selected",{workflowDefinitionId:e.getAttribute("workflowDefinitionId"),workflowInstanceId:e.getAttribute("workflowInstanceId"),workflowName:e.getAttribute("workflowName")}))}.bind(this))}.bind(this)}):"active"==t?o.getDefinitionNames({success:function(t){this.workflowDefinitions={},t.each(function(t){this.workflowDefinitions[t.getAttribute("id")]=t}.bind(this)),l.getSuspendedInstances({active:!0,success:function(t){l.getSuspendedInstancesDetails({sortBy:this.sortBy,sortOrder:this.sortOrder,offset:this.offset,limit:this.limit,completed:this.showCompleted,unfinished:this.showActive,wfInstanceCollection:t,success:function(t){var i=new e.Collection;t.each(function(t){var s=new e.Model,n=t.getAttribute("definitionId"),o="";this.workflowDefinitions[n]&&(o=this.workflowDefinitions[n].getAttribute("name")),s.setAttribute("workflowName",o),s.setAttribute("workflowVersion",this.workflowDefinitions[n].getAttribute("version")),s.setAttribute("shortWorkflowInstanceId",t.getAttribute("id")),s.setAttribute("workflowInstanceId",t.getAttribute("id")),s.setAttribute("workflowDefinitionId",n),s.setAttribute("startTime",t.getAttribute("startTime")),s.setAttribute("endTime",t.getAttribute("endTime")),s.setAttribute("superProcessInstanceId",t.getAttribute("superProcessInstanceId")),i.addModel(s)}.bind(this)),i=this.arrangeHierarchically(i),this.table.setData(i.toJSON()),this.table.attachTo(this.view.getTableContent())}.bind(this)})}.bind(this)}),this.highlightedRow=null,this.table.addEventHandler("rowclick",function(t,e){t.isHighlighted()?(t.highlight(!1),this.highlightedRow=null,this.getEventBus().publish("instance-deselected",t.getData().attributes)):(null!=this.highlightedRow&&(this.highlightedRow.highlight(!1),this.getEventBus().publish("instance-deselected",this.highlightedRow.getData().attributes),this.highlightedRow=null),t.highlight(!0),this.highlightedRow=t,this.getEventBus().publish("instance-selected",{workflowDefinitionId:e.getAttribute("workflowDefinitionId"),workflowInstanceId:e.getAttribute("workflowInstanceId"),workflowName:e.getAttribute("workflowName")}))}.bind(this))}.bind(this)}):"suspended"==t&&o.getDefinitionNames({success:function(t){this.workflowDefinitions={},t.each(function(t){this.workflowDefinitions[t.getAttribute("id")]=t}.bind(this)),l.getSuspendedInstances({suspended:!0,success:function(t){l.getSuspendedInstancesDetails({sortBy:this.sortBy,sortOrder:this.sortOrder,offset:this.offset,limit:this.limit,completed:this.showCompleted,unfinished:this.showActive,wfInstanceCollection:t,success:function(t){var i=new e.Collection;t.each(function(t){var s=new e.Model,n=t.getAttribute("definitionId"),o="";this.workflowDefinitions[n]&&(o=this.workflowDefinitions[n].getAttribute("name")),s.setAttribute("workflowName",o),s.setAttribute("workflowVersion",this.workflowDefinitions[n].getAttribute("version")),s.setAttribute("shortWorkflowInstanceId",t.getAttribute("id")),s.setAttribute("workflowInstanceId",t.getAttribute("id")),s.setAttribute("workflowDefinitionId",n),s.setAttribute("startTime",t.getAttribute("startTime")),s.setAttribute("endTime",t.getAttribute("endTime")),s.setAttribute("superProcessInstanceId",t.getAttribute("superProcessInstanceId")),i.addModel(s)}.bind(this)),i=this.arrangeHierarchically(i),this.table.setData(i.toJSON()),this.table.attachTo(this.view.getTableContent())}.bind(this)})}.bind(this)}),this.highlightedRow=null,this.table.addEventHandler("rowclick",function(t,e){t.isHighlighted()?(t.highlight(!1),this.highlightedRow=null,this.getEventBus().publish("instance-deselected",t.getData().attributes)):(null!=this.highlightedRow&&(this.highlightedRow.highlight(!1),this.getEventBus().publish("instance-deselected",this.highlightedRow.getData().attributes),this.highlightedRow=null),t.highlight(!0),this.highlightedRow=t,this.getEventBus().publish("instance-selected",{workflowDefinitionId:e.getAttribute("workflowDefinitionId"),workflowInstanceId:e.getAttribute("workflowInstanceId"),workflowName:e.getAttribute("workflowName")}))}.bind(this))}.bind(this)})},getEventBus:function(){return this.table.getEventBus()},showPagination:function(){this.hidePagination();var t=null,e=null;"all"==this.filter&&(t=null,e=null),"active"==this.filter&&(t=!0,e=!1),"suspended"==this.filter&&(t=!1,e=!0),r.getWorkflowInstanceActive({active:t,suspended:e,success:function(t){var e=Math.ceil(t/19);this.pagination=new n({pages:e,onPageChange:function(t){var e=19*(t-1);this.refresh({offset:e,limit:19})}.bind(this)}),this.pagination.attachTo(this.view.getPagination())}.bind(this)})},hidePagination:function(){null!=this.pagination&&(this.pagination.destroy(),this.pagination=null)},arrangeHierarchically:function(t){var i=!0,s=t,n=new e.Collection;return s.each(function(t){var e=s.searchMap(t.get("workflowInstanceId"),["superProcessInstanceId"]);e.size()?(n.addModel(t),e.each(function(e){0==s.searchMap(t.get("superProcessInstanceId"),["workflowInstanceId"]).size()?e.setAttribute("workflowName",". . . ".concat(e.getAttribute("workflowName"))):e.setAttribute("workflowName",". . . . . . ".concat(e.getAttribute("workflowName")))}),n.addModel(e._collection.models)):0==s.searchMap(t.get("superProcessInstanceId"),["workflowInstanceId"]).size()&&n.addModel(t),i=!i}),n}.bind(this)})});