/* Copyright (c) Ericsson 2015 */

define("styles!widget/WfUsertasks/TaskTable/TaskTable.less",function(){return""}),define("text!widget/WfUsertasks/TaskTable/TaskTable.html",function(){return'<div class="eaNFE_automation_TaskTable">\r\n    <div class="eaNFE_automation_TaskTable-contentTaskTable"></div>\r\n   <!--  <div class="ebLayout-SectionHeading eaNFE_automation_UI-Usertasks-SectionHeading">\r\n    	<div class="eaNFE_automation_UI-Usertasks-SectionHeading-Title"><h2>All Tasks</h2>\r\n        	<div class="eaNFE_automation_UI-Usertasks-contentTable-buttonRefresh"><i class="ebIcon ebIcon_refresh"></i></div>\r\n    	</div>\r\n    </div>    -->\r\n</div>\r\n'}),define("widget/WfUsertasks/TaskTable/TaskTableView",["jscore/core","text!./TaskTable.html","styles!./TaskTable.less"],function(t,e,s){return t.View.extend({getTemplate:function(){return e},getStyle:function(){return s},getTaskTableContent:function(){return this.getElement().find(".eaNFE_automation_TaskTable-contentTaskTable")},getHeadingContent:function(){return this.getElement().find(".eaNFE_automation_UI-Usertasks-SectionHeading")}})}),define("widget/WfUsertasks/TaskTable/TaskTable",["jscore/core","./TaskTableView","jscore/ext/mvp","tablelib/Table","3pps/wfs/WfDefinitionClient","3pps/wfs/WfUsertaskClient","./TaskActionsCell/TaskActionsCell","./TaskProgressCell/TaskProgressCell","../../WfBarPercentageCell/WfBarPercentageCell","tablelib/plugins/StickyHeader","tablelib/plugins/StickyScrollbar","tablelib/plugins/Selection","tablelib/plugins/SortableHeader","jscore/ext/locationController","widget/WfUsertasks/TaskForm/TaskForm"],function(t,e,s,i,n,o,a,r,l,d,c,h,f,u,b){return t.Widget.extend({View:e,init:function(){this.offset=this.options.offset?this.options.offset:0,this.limit=this.options.limit?this.options.limit:20,this.active=this.options.active?this.options.active:null,this.suspended=this.options.suspended?this.options.suspended:null},onViewReady:function(){function t(){this._inContext=!1,this.options.regionEventBus.publish("topsection:leavecontext")}function e(){this._inContext=!0,this.options.regionEventBus.publish("topsection:contextactions",[{type:"button",color:"blue",name:"Start User Task",action:o.bind(this)},{type:"separator"},{type:"link",icon:"tick",flat:!0,name:"View Diagram",action:n.bind(this)}])}function n(){this.table.getSelectedRows().forEach(function(t){this.options.regionEventBus.publish("showdiagram",t.options.model)},this),t.call(this)}function o(){this.table.getSelectedRows().forEach(function(t){this.table.detach();var e=new s.Model(t.options.model);this.showForm(e)}.bind(this)),t.call(this)}var a=[{title:"Task",attribute:"name",width:"100px",sortable:!0},{title:"Version",attribute:"workflowVersion",width:"100px",sortable:!0},{title:"Instance Id",attribute:"shortWorkflowInstanceId",width:"150px",sortable:!0},{title:"Workflow",attribute:"workflowName",width:"100px",sortable:!0},{title:"Created",attribute:"created",width:"100px",sortable:!0}];this.table=new i({plugins:[new h({selectableRows:!0,multiselect:!0}),new c,new d({topOffset:34}),new f],selectableRows:!0,modifiers:["striped"],columns:a}),this.renderUserTaskTable(),this.table.addEventHandler("sort",function(t,e){this.table.setData(this.getSortedData(t,e))}.bind(this)),this.table.addEventHandler("rowselectend",function(s){s.length>0&&!this._inContext?e.call(this):0===s.length&&t.call(this)}.bind(this)),this.options.regionEventBus.subscribe("showHeaderActive",function(t){}.bind(this))},getSortedData:function(t,e){return this.wfUsertaskCollection2.sort(e,t),this.wfUsertaskCollection2.toJSON()},showForm:function(t){this.TaskForm=new b({wfUsertaskModel:t,taskHandledCallback:this.taskHandledCallback.bind(this),regionEventBus:this.options.regionEventBus}),this.TaskForm.attachTo(this.view.getTaskTableContent())},taskHandledCallback:function(t){this.hideForm(),this.refreshButtonClicked(),1==t&&setTimeout(function(){this.options.regionEventBus.publish("something-changed","usertasks")}.bind(this),2e3)},refreshButtonClicked:function(){this.TaskTable||this.renderUserTaskTable(),this.hideForm()},hideForm:function(){null!=this.TaskForm&&(this.TaskForm.destroy(),this.TaskForm=null)},getEventBus:function(){return this.table.getEventBus()},refresh:function(t){this.limit=t.limit,this.offset=t.offset,this.renderUserTaskTable()},renderUserTaskTable:function(){n.getDefinitionNames({success:function(t){this.wfUsertaskCollection2=new s.Collection,this.workflowDefinitions={},this.TaskProgress={},t.each(function(t){this.workflowDefinitions[t.getAttribute("id")]=t}.bind(this)),o.getUsertasks({sortBy:"created",sortOrder:"desc",offset:this.offset,limit:this.limit,active:this.active,suspended:this.suspended,success:function(t){t.each(function(t){wfUsertaskModel2=new s.Model,wfUsertaskModel2.setAttribute("id",t.getAttribute("id")),wfUsertaskModel2.setAttribute("definitionId",t.getAttribute("taskDefinitionKey")),wfUsertaskModel2.setAttribute("name",t.getAttribute("name")),wfUsertaskModel2.setAttribute("created",t.getAttribute("created")),wfUsertaskModel2.setAttribute("workflowDefinitionId",t.getAttribute("processDefinitionId")),wfUsertaskModel2.setAttribute("workflowName",this.workflowDefinitions[t.getAttribute("processDefinitionId")].getAttribute("name")),wfUsertaskModel2.setAttribute("workflowVersion",this.workflowDefinitions[t.getAttribute("processDefinitionId")].getAttribute("version")),wfUsertaskModel2.setAttribute("shortWorkflowInstanceId",t.getAttribute("processInstanceId").substring(0,8)),wfUsertaskModel2.setAttribute("workflowInstanceId",t.getAttribute("processInstanceId"));var e=this.wfUsertaskCollection2.search(t.getAttribute("id"),["id"]);0==e.length&&this.wfUsertaskCollection2.addModel(wfUsertaskModel2)}.bind(this)),this.table.setData(this.wfUsertaskCollection2.toJSON()),this.table.attachTo(this.getElement())}.bind(this)})}.bind(this)})}})});