/* Copyright (c) Ericsson 2015 */

define("widget/WfAllDefinitions/WfAllDefinitionsTable/WfAllDefinitionsTable",["jscore/core","jscore/ext/mvp","tablelib/Table","3pps/wfs/WfDefinitionClient","./WfAllDefinitionActionsCell/WfAllDefinitionActionsCell","jscore/ext/locationController","widgets/table/Row","tablelib/plugins/StickyHeader","tablelib/plugins/StickyScrollbar","tablelib/plugins/Selection","tablelib/plugins/SortableHeader"],function(t,e,i,n,o,s,l,r,a,c,b){return t.Widget.extend({onViewReady:function(){function t(){this._inContext=!1,this.options.regionEventBus.publish("topsection:leavecontext")}function e(){this._inContext=!0,this.options.regionEventBus.publish("topsection:contextactions",[{type:"button",color:"blue",name:"Start Instance",action:n.bind(this)},{type:"separator"},{type:"link",icon:"tick",flat:!0,name:"View Instance",action:o.bind(this)}])}function n(){this.table.getSelectedRows().forEach(function(t){this.options.regionEventBus.publish("createinstance",t.options.model),this.renderDefinitionTable()}.bind(this)),t.call(this)}function o(){this.table.getSelectedRows().forEach(function(t){var e=new s,i="workflowinstancen/"+t.options.model.workflowDefinitionId+"/"+t.options.model.workflowName+"/"+t.options.model.shortWorkflowInstanceId+"/"+t.options.model.startTime+"/"+t.options.model.workflowVersion;e.setLocation(i)}),t.call(this)}this.options.showAllVersions;this.columns=[{title:"Workflow",attribute:"name",sortable:!0},{title:"Version",attribute:"version",width:"80px",sortable:!0},{title:"Created",attribute:"createdOnStr",sortable:!0},{title:"Category",attribute:"category",sortable:!0,sortable:!0},{title:"Description",width:"300px",attribute:"description"}],this.table=new i({plugins:[new c({selectableRows:!0,multiselect:!0}),new a,new r({topOffset:34}),new b],selectableRows:!0,modifiers:["striped"],columns:this.columns}),this.renderDefinitionTable(),this.table.addEventHandler("sort",function(t,e){this.table.setData(this.getSortedData(t,e))}.bind(this)),this.table.addEventHandler("rowselectend",function(i){i.length>0&&!this._inContext?e.call(this):0===i.length&&t.call(this)}.bind(this))},getSortedData:function(t,e){return this.wfDefinitionCollection.sort(e,t),this.wfDefinitionCollection.toJSON()},renderDefinitionTable:function(){var t=this.options.showAllVersions;n.getAllDefinitions({latest:!t,sortBy:"name",sortOrder:"asc",sortingMode:"asc",sortingAttribute:"category",success:function(t){this.wfDefinitionCollection=new e.Collection,t.each(function(t){var i=new e.Model;i.setAttribute("id",t.getAttribute("id")),i.setAttribute("name",t.getAttribute("name")),i.setAttribute("key",t.getAttribute("key")),i.setAttribute("version",t.getAttribute("version")),i.setAttribute("category",t.getAttribute("category")),i.setAttribute("description",t.getAttribute("description")),i.setAttribute("createdOnStr",t.getAttribute("createdOnStr")),this.wfDefinitionCollection.addModel(i)}.bind(this)),this.table.setData(this.wfDefinitionCollection.toJSON()),this.table.attachTo(this.getElement())}.bind(this)})}})});