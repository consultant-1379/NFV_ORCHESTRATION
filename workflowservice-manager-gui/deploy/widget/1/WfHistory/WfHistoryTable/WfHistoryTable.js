/* Copyright (c) Ericsson 2015 */

define("styles!widget/WfHistory/WfHistoryTable/WfHistoryTable.less",function(){return""}),define("text!widget/WfHistory/WfHistoryTable/WfHistoryTable.html",function(){return'<div class="eaNFE_automation_UI-WfHistoryTable">\r\n    <div class="eaNFE_automation_UI-WfHistoryTable-contentTable eb_scrollbar"></div>\r\n    <div class="eaNFE_automation_UI-WfHistoryTable-contentTable-Pagination"></div>\r\n</div>\r\n'}),define("widget/WfHistory/WfHistoryTable/WfHistoryTableView",["jscore/core","text!./WfHistoryTable.html","styles!./WfHistoryTable.less"],function(t,e,i){return t.View.extend({getTemplate:function(){return e},getStyle:function(){return i},getTableContent:function(){return this.getElement().find(".eaNFE_automation_UI-WfHistoryTable-contentTable")},getPagination:function(){return this.getElement().find(".eaNFE_automation_UI-WfHistoryTable-contentTable-Pagination")}})}),define("widget/WfHistory/WfHistoryTable/WfHistoryTable",["jscore/core","jscore/ext/mvp","./WfHistoryTableView","tablelib/Table","widgets/Pagination","3pps/wfs/WfDefinitionClient","3pps/wfs/WfInstanceClient","../../WfBarPercentageCell/WfBarPercentageCell","jscore/ext/locationController","widgets/table/Row","../../../widget/WfUsertasks/TaskTable/TaskDiagramCell/TaskDiagramCell","tablelib/plugins/StickyHeader","tablelib/plugins/StickyScrollbar","tablelib/plugins/Selection","tablelib/plugins/SortableHeader"],function(t,e,i,s,n,o,a,r,l,h,c,d,u,f,b){return t.Widget.extend({View:i,init:function(){this.offset=this.options.offset?this.options.offset:0,this.limit=this.options.limit?this.options.limit:20,this.sortBy=this.options.sortBy?this.options.sortBy:"endTime",this.sortOrder=this.options.sortOrder?this.options.sortOrder:"desc",this.showActive=this.options.showActive,this.showCompleted=this.options.showCompleted,this.hidePercentage=this.options.hidePercentage,this.hideActionButtons=this.options.hideActionButtons},onViewReady:function(){function t(){this._inContext=!1,this.options.regionEventBus.publish("topsection:leavecontext")}function e(){this._inContext=!0,this.options.regionEventBus.publish("topsection:contextactions",[{type:"link",icon:"tick",flat:!0,name:"View Diagram",action:i.bind(this)}])}function i(){this.table.getSelectedRows().forEach(function(t){this.options.regionEventBus.publish("showdiagram",t.options.model)},this),t.call(this)}this.columns=[{title:"Workflow",attribute:"workflowName",sortable:!0},{title:"Version",attribute:"workflowVersion",width:"100px",sortable:!0},{title:"Instance Id",attribute:"shortWorkflowInstanceId",width:"100px",sortable:!0}],this.showActive&&this.columns.push({title:"Start Time",attribute:"startTime",width:"150px",sortable:!0}),this.showCompleted&&this.columns.push({title:"End Time",attribute:"endTime",width:"150px",sortable:!0}),this.table=new s({plugins:[new f({selectableRows:!0,multiselect:!0}),new u,new d({topOffset:34}),new b],selectableRows:!0,columns:this.columns}),this.renderInstanceTable(),this.showPagination(),this.table.addEventHandler("sort",function(t,e){this.table.setData(this.getSortedData(t,e))}.bind(this)),this.table.addEventHandler("rowselectend",function(i){i.length>0&&!this._inContext?e.call(this):0===i.length&&t.call(this)}.bind(this))},getSortedData:function(t,e){return this.tableInstances.sort(e,t),this.tableInstances.toJSON()},subscribeForPushEvents:function(t){this.regionEventBus=t,this.regionEventBus.subscribe("instance-event",function(t){this.handlePushEvent(t)}.bind(this))},handlePushEvent:function(t){setTimeout(function(){this.renderInstanceTable()}.bind(this),2e3)},refresh:function(t){this.limit=t.limit,this.offset=t.offset,this.renderInstanceTable()},renderInstanceTable:function(){o.getDefinitionNames({success:function(t){this.getProcessDefinitionId();this.workflowDefinitions={},t.each(function(t){this.workflowDefinitions[t.getAttribute("id")]=t}.bind(this)),a.getInstances({sortBy:this.sortBy,sortOrder:this.sortOrder,offset:this.offset,limit:this.limit,completed:this.showCompleted,active:this.showActive,success:function(t){this.tableInstances=new e.Collection,t.each(function(t){var i=new e.Model,s=t.getAttribute("definitionId");i.setAttribute("workflowName",this.workflowDefinitions[s].getAttribute("name")),i.setAttribute("workflowVersion",this.workflowDefinitions[s].getAttribute("version")),i.setAttribute("shortWorkflowInstanceId",t.getAttribute("id").substring(0,8)),i.setAttribute("workflowInstanceId",t.getAttribute("id")),i.setAttribute("workflowDefinitionId",s),i.setAttribute("startTime",t.getAttribute("startTime")),i.setAttribute("endTime",t.getAttribute("endTime")),i.setAttribute("startActivityId",t.getAttribute("startActivityId")),i.setAttribute("superProcessInstanceId",t.getAttribute("superProcessInstanceId")),this.tableInstances.addModel(i)}.bind(this)),this.tableInstances=this.arrangeHierarchically(this.tableInstances),this.tableInstances.sort("endTime","desc"),this.table.setData(this.tableInstances.toJSON());var i="parent",s=!0;for(var n in this.table.getRows()){var o=this.table.getRows()[n].options.model.workflowName;i=-1!=o.indexOf(". . . ")?"child":"parent","parent"===i&&(s=!s),s&&this.table.getRows()[n].getElement().setStyle("background-color","#f2f2f2")}this.table.attachTo(this.view.getTableContent())}.bind(this)}),this.highlightedRow=null,this.table.addEventHandler("rowclick",function(t,e){t.isHighlighted()?(t.highlight(!1),this.highlightedRow=null,this.options.regionEventBus.publish("instance-deselected",t.getData().attributes)):(null!=this.highlightedRow&&(this.highlightedRow.highlight(!1),this.options.regionEventBus.publish("instance-deselected",this.highlightedRow.getData().attributes),this.highlightedRow=null),t.highlight(!0),this.highlightedRow=t,this.options.regionEventBus.publish("instance-selected",{workflowDefinitionId:e.getAttribute("workflowDefinitionId"),workflowInstanceId:e.getAttribute("workflowInstanceId"),workflowName:e.getAttribute("workflowName")}))}.bind(this))}.bind(this)})},getProcessDefinitionId:function(){var t=window.location.hash,e=t.substring(t.indexOf("/")+1).split("/");return e[0]},showPagination:function(){this.hidePagination(),a.getInstancesCount({completed:!0,success:function(t){var e=Math.ceil(t/20);this.pagination=new n({pages:e,onPageChange:function(t){var e=20*(t-1);this.refresh({offset:e,limit:20})}.bind(this)}),this.pagination.attachTo(this.view.getPagination())}.bind(this)})},hidePagination:function(){null!=this.pagination&&(this.pagination.destroy(),this.pagination=null)},arrangeHierarchically:function(t){var i=!0,s=t,n=new e.Collection;return s.each(function(t){var e=s.searchMap(t.get("workflowInstanceId"),["superProcessInstanceId"]);e.size()?(n.addModel(t),e.each(function(e){0==s.searchMap(t.get("superProcessInstanceId"),["workflowInstanceId"]).size()?e.setAttribute("workflowName",". . . ".concat(e.getAttribute("workflowName"))):e.setAttribute("workflowName",". . . . . . ".concat(e.getAttribute("workflowName")))}),n.addModel(e._collection.models)):0==s.searchMap(t.get("superProcessInstanceId"),["workflowInstanceId"]).size()&&n.addModel(t),i=!i}),n}.bind(this)})});