/* Copyright (c) Ericsson 2015 */

define("styles!widget/WfHistory/WfHistory.less",function(){return".eaNFE_automation_UI-WfHistory {\n  min-height: 288px;\n  width: 100%;\n  height: 100%;\n}\n.eaNFE_automation_UI-WfHistory-SectionHeading-Title {\n  float: left;\n}\n.eaNFE_automation_UI-WfHistory-SectionHeading-Extra {\n  padding-top: 10px;\n  padding-bottom: 10px;\n}\n.eaNFE_automation_UI-WfHistory-SectionHeading-Filter {\n  padding-top: 10px;\n  float: right;\n}\n.eaNFE_automation_UI-WfHistory-closelink {\n  color: black;\n  cursor: pointer;\n  text-decoration: none;\n  /* no underline */\n\n}\n.eaNFE_automation_UI-WfHistory-closelink:hover {\n  color: black;\n  cursor: pointer;\n  text-decoration: none;\n  /* no underline */\n\n}\n.eaNFE_automation_UI-WfHistory-handleBarButton-diagramName {\n  padding-top: 10px;\n  font-size: 2rem;\n  float: left;\n  display: inline-block;\n}\n.eaNFE_automation_UI-WfHistory-handleBarButton-closeDiagram {\n  cursor: pointer;\n  display: inline-block;\n}\n.eaNFE_automation_UI-WfHistory-contentTable {\n  min-height: auto;\n  max-height: calc(100% - 60px);\n  overflow: hidden;\n}\n.eaNFE_automation_UI-WfHistory-contentTable-buttonRefresh {\n  float: left;\n  vertical-align: bottom;\n  margin-left: 15px;\n  margin-top: 10px;\n  padding-top: 5px;\n  cursor: pointer;\n  cursor: hand;\n}\n.eaNFE_automation_UI-WfHistory-contentTable-BottomDivider {\n  border-bottom: 1px solid #666666;\n  width: 100%;\n  padding-bottom: 5px;\n}\n"}),define("text!widget/WfHistory/WfHistory.html",function(){return'<div class="eaNFE_automation_UI-WfHistory">\r\n    <div class="ebLayout-SectionHeading eaNFE_automation_UI-WfHistory-SectionHeading">\r\n        <div class="eaNFE_automation_UI-WfHistory-SectionHeading-Title"><h2>Workflow Instances</h2>\r\n            <div class="eaNFE_automation_UI-WfHistory-contentTable-buttonRefresh"><i class="ebIcon ebIcon_refresh"></i></div>\r\n        </div>\r\n       <!--  <div class="eaNFE_automation_UI-WfHistory-SectionHeading-Filter"></div> -->\r\n    </div>\r\n  <!--   <div class="eaNFE_automation_UI-WfHistory-handleBarButton">\r\n		<div class="eaNFE_automation_UI-WfHistory-handleBarButton-diagramName"></div>\r\n		<div class="eaNFE_automation_UI-WfHistory-handleBarButton-closeDiagram"><i class="ebIcon ebIcon_large ebIcon_close_red"></i>close diagram</div>\r\n	    <div class="eaNFE_automation_UI-WfHistory-contentTable"></div>\r\n    </div> -->\r\n    \r\n    <div class="eaNFE_automation_UI-WfHistory-handleBarButton ebLayout-SectionSubheading">\r\n    <div class="eaNFE_automation_UI-WfHistory-handleBarButton-diagramName"></div>\r\n  		<h3 class="eaNFE_automation_UI-WfHistory-handleBarButton-handleBar"></h3>\r\n  		<div class="ebLayout-HeadingCommands">\r\n	    	<div class="ebLayout-HeadingCommands-block">\r\n	    		<a class="eaNFE_automation_UI-WfHistory-closelink" title="Close Diagram">Close Diagram</a>\r\n	      		<div class="eaNFE_automation_UI-WfHistory-handleBarButton-closeDiagram ebLayout-HeadingCommands-iconHolder">\r\n	        		<i class="ebIcon ebIcon_large ebIcon_close_red" title="Close Diagram"></i>\r\n	      		</div>\r\n    		</div>\r\n  		</div>\r\n  		<div class="ebLayout-clearFix"></div>\r\n	</div>   \r\n	<div class="eaNFE_automation_UI-WfHistory-contentTable"></div>\r\n    <div class="eaNFE_automation_UI-WfHistory-contentTable-BottomDivider"></div>\r\n    <div class="eaNFE_automation_UI-WfHistory-contentTablePagination"></div>\r\n    <div class="eaNFE_automation_UI-WfHistory-contentTaskForm"></div>\r\n</div>\r\n'}),define("widget/WfHistory/WfHistoryView",["jscore/core","text!./WfHistory.html","styles!./WfHistory.less"],function(t,e,i){return t.View.extend({getTemplate:function(){return e},getStyle:function(){return i},getTableContent:function(){return this.getElement().find(".eaNFE_automation_UI-WfHistory-contentTable")},getRefreshButton:function(){return this.getElement().find(".eaNFE_automation_UI-WfHistory-contentTable-buttonRefresh")},getDiagramName:function(){return this.getElement().find(".eaNFE_automation_UI-WfHistory-handleBarButton-diagramName")},getCloseDiagram:function(){return this.getElement().find(".eaNFE_automation_UI-WfHistory-handleBarButton-closeDiagram")},getCloseLink:function(){return this.getElement().find(".ebLayout-HeadingCommands")},getHeaderContent:function(){return this.getElement().find(".eaNFE_automation_UI-WfHistory-handleBarButton")}})}),define("widget/WfHistory/WfHistory",["jscore/core","widgets/SelectBox","widgets/Pagination","../WfProgress/WfProgress","./WfHistoryTable/WfHistoryTable","./WfHistoryView","3pps/wfs/WfInstanceClient","../WfDiagram/WfDiagram","../../widget/WfProgress/WfProgressModel"],function(t,e,i,n,s,o,a,r,l){return t.Widget.extend({View:o,onViewReady:function(){this.regionEventBus=null!=this.options.regionContext.eventBus?this.options.regionContext.eventBus:null,this.refreshButtonVisible=null!=this.options.refreshButtonVisible?this.options.refreshButtonVisible:!0,this.filterValueActive=null!=this.options.filterValueActive?this.options.filterValueActive:!0,this.showingProgress=null!=this.options.showingProgress?this.options.showingProgress:!0,this.showingDiagram=null!=this.options.showingDiagram?this.options.showingDiagram:!0,this.view.getHeaderContent().setStyle("display","none"),this.view.getCloseDiagram().addEventHandler("click",function(){this.wfDiagram&&(this.wfDiagram.detach(),this.wfDiagram.destroy(),this.wfDiagram=void 0),this.wfDiagram||this.showTable(),this.toggleHandleBarView(),this.view.getHeaderContent().setStyle("display","inline-block"),this.regionEventBus.publish("instanceTable-refreshed","refresh")}.bind(this)),this.view.getCloseLink().addEventHandler("click",function(){this.wfDiagram&&(this.wfDiagram.detach(),this.wfDiagram.destroy(),this.wfDiagram=void 0),this.wfDiagram||this.showTable(),this.toggleHandleBarView(),this.view.getCloseLink().setStyle("display","none"),this.view.getHeaderContent().setStyle("display","none"),this.regionEventBus.publish("instanceTable-refreshed","refresh")}.bind(this)),this.view.getRefreshButton().setStyle("visibility",1==this.refreshButtonVisible?"visible":"hidden"),this.showTable()},update:function(){this.trigger("updateServiceCall","update"),this.refreshButtonClicked(),this.regionEventBus.publish("instanceTable-refreshed","refresh")},Update:function(){this.wfDiagram&&(this.wfDiagram.detach(),this.TaskTable.attach())},showTable:function(){this.hideTable(),this.WfHistoryTable=new s({offset:0,limit:20,sortBy:"endTime",sortOrder:"desc",showActive:!1,showCompleted:!0,hidePercentage:this.options.hidePercentage,regionEventBus:this.regionEventBus}),this.WfHistoryTable.attachTo(this.view.getTableContent()),this.tableContentHeight&&this.view.getTableContent().setStyle("height","auto"),this.WfHistoryTable.options.regionEventBus.subscribe("showdiagram",function(t){l.build({workflowDefinitionId:t.workflowDefinitionId,workflowInstanceId:t.workflowInstanceId,success:function(e){this.wfStructureModel=e.wfStructureModel,this.wfProgressModel=e.wfProgressModel,this.keyableStatus=e.keyableStatus,this.keyableCount=e.keyableCount,this.percentComplete=e.percentComplete,this.calledWorkflows=e.calledWorkflows;var i=this.buildOverlays(this.keyableStatus,this.keyableCount);if(!this.wfDiagram){this.wfDiagram=new r({xid:"prg-",wfDefinitionId:t.workflowDefinitionId,wfName:t.workflowName,highlights:i.highlights,countBadges:i.countBadges}),this.view.getDiagramName().setStyle("display","block"),this.view.getCloseLink().setStyle("display","inline-block"),this.view.getHeaderContent().setStyle("display","inline-block");var n=t.workflowName;this.view.getDiagramName().setText(n)}this.WfHistoryTable.detach(),this.wfDiagram.attachTo(this.view.getTableContent())}.bind(this),error:function(t){console.log(t)}.bind(this)})}.bind(this))},buildOverlays:function(t,e){var i=[],n=[];for(var s in t){var o=t[s];if(o&&null!=o&&""!==o){i.push({nodeId:s,style:"highlight-"+o});var a=e[s];a&&a>0&&(a>1||1==a&&"Started"===o)&&n.push({nodeId:s,count:a})}}return{highlights:i,countBadges:n}},rowSelectionHandle:function(){this.WfHistoryTable.getEventBus().subscribe("instance-selected",function(t){this.progressIds=t,this.regionEventBus.publish("instance-selected",t),this.showingProgress&&this.showProgress(t),this.showingDiagram&&this.WfProgress.showDiagram()}.bind(this)),this.WfHistoryTable.getEventBus().subscribe("instance-deselected",function(t){this.progressIds=t,this.regionEventBus.publish("instance-deselected",t),this.showingProgress&&this.WfProgress.hideDiagram(),this.showingDiagram&&this.hideProgress()}.bind(this))},refreshButtonClicked:function(){this.WfHistoryTable||this.showTable(),null!=this.WfProgress&&this.WfProgress.hideDiagram(),this.hideProgress()},hideTable:function(){null!=this.WfHistoryTable&&(this.tableContentHeight=this.view.getTableContent().getStyle("height"),this.WfHistoryTable.destroy(),this.WfHistoryTable=null,this.view.getTableContent().setStyle("height","0px"))},toggleHandleBarView:function(){this.view.getDiagramName().setStyle("display","none")},showPagination:function(){this.hidePagination(),a.getInstancesCount({processDefinitionId:this.processDefinitionId,active:this.getFilterValue().historicView?!1:!0,completed:this.getFilterValue().historicView?!0:!1,success:function(t){var e=Math.ceil(t/this.getPageLimit());this.pagination=new i({pages:e,onPageChange:function(t){var e=(t-1)*this.getPageLimit();this.WfHistoryTable.refresh({offset:e,limit:this.getPageLimit()})}.bind(this)}),this.pagination.attachTo(this.view.getTableContent())}.bind(this)})},hidePagination:function(){null!=this.pagination&&(this.pagination.destroy(),this.pagination=null)},showProgress:function(t,e){this.hideProgress(),this.WfProgress=new n({regionEventBus:this.regionEventBus,ids:t,showingDiagram:e,doneCallback:this.progressClosed.bind(this)}),this.regionEventBus.publish("display-progress",["progress",this.WfProgress]),t.hasOwnProperty("childExecutionId")&&this.showExtra("Showing progress for child Id: "+t.childExecutionId.substring(0,8))},progressClosed:function(){this.progressIds.hasOwnProperty("childExecutionId")||this.progressIds.hasOwnProperty("subProcessId")?(delete this.progressIds.childExecutionId,delete this.progressIds.childDefinitionId,delete this.progressIds.subProcessId,this.hideProgress(),this.showProgress(this.progressIds,!1)):(this.hideProgress(),this.selectBox.enable(),this.showTable(),!this.getFilterValue().liveView&&this.allowPagination&&this.showPagination())},hideProgress:function(){null!=this.WfProgress&&(this.WfProgress.destroy(),this.WfProgress=null)},getProcessDefinitionId:function(){var t=window.location.hash,e=t.substring(t.indexOf("/")+1).split("/");return e[0]}})});