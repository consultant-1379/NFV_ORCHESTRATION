/* Copyright (c) Ericsson 2015 */

define("styles!widget/WfInstanceProcessIcon/wfInstanceProcessIcon.less",function(){return".eaNFE_automation_UI-WfInstanceProcessIcon-contentTable-table {\n  display: list-item;\n}\n.eaNFE_automation_UI-WfInstanceProcessIcon-contentTable-WfInstanceProcessIconActive {\n  display: inline-block;\n  vertical-align: middle;\n  background: url('widget/1/resources/widget/WfInstanceProcessIcon/active_icon_24px.svg');\n  background-repeat: no-repeat;\n  height: 40px;\n  width: 25px;\n  padding-left: 20px;\n}\n.eaNFE_automation_UI-WfInstanceProcessIcon-contentTable-WfInstanceProcessIconCancelled {\n  display: inline-block;\n  vertical-align: middle;\n  background: url('widget/1/resources/widget/WfInstanceProcessIcon/cancelled_icon_24px.svg');\n  background-repeat: no-repeat;\n  height: 40px;\n  width: 25px;\n  padding-left: 20px;\n}\n"}),define("text!widget/WfInstanceProcessIcon/wfInstanceProcessIcon.html",function(){return'<td class="eaNFE_automation_UI-WfInstanceProcessIcon-contentTable-table">\r\n	<div class="eaNFE_automation_UI-WfInstanceProcessIcon-contentTable-WfInstanceProcessIconActive"></div>\r\n	<div class="eaNFE_automation_UI-WfInstanceProcessIcon-contentTable-WfInstanceProcessIconCancelled"></div>\r\n</td>'}),define("widget/WfInstanceProcessIcon/WfInstanceProcessIconView",["jscore/core","text!./wfInstanceProcessIcon.html","styles!./wfInstanceProcessIcon.less"],function(t,e,n){return t.View.extend({getTemplate:function(){return e},getStyle:function(){return n},showActiveIcon:function(){this.getIconCancelled().element.style.setProperty("display","none",null),this.getIconActive().element.style.setProperty("display","block",null)},showCancelledIcon:function(){this.getIconActive().element.style.setProperty("display","none",null),this.getIconCancelled().element.style.setProperty("display","block",null)}})}),define("widget/WfInstanceProcessIcon/WfInstanceProcessIcon",["widgets/table/Cell","./WfInstanceProcessIconView"],function(t,e){return t.extend({View:e,setStatus:function(t){"active"===t?this.activeStatus():"cancelled"===t&&this.cancelledStatus()},activeStatus:function(){this.view.showActiveIcon()},cancelledStatus:function(){this.view.showCancelledIcon()}})}),define("widget/WfInstances/WfInstancesTable/WfInstancesTable",["jscore/core","jscore/ext/mvp","../WfInstancesView","widgets/Table","3pps/wfs/WfDefinitionClient","3pps/wfs/WfCountsClient","../../WfBarPercentageCell/WfBarPercentageCell","../../WfInstanceProcessIcon/WfInstanceProcessIcon","jscore/ext/locationController","widgets/table/Row","widgets/Notification","tablelib/plugins/StickyHeader","tablelib/plugins/StickyScrollbar","tablelib/plugins/Selection","tablelib/plugins/SortableHeader"],function(t,e,n,s,i,o,a,c,r,l,h,d,u,f,w){return t.Widget.extend({init:function(){this.offset=this.options.offset?this.options.offset:0,this.limit=this.options.limit?this.options.limit:20,this.sortBy=this.options.sortBy?this.options.sortBy:"startTime",this.sortOrder=this.options.sortOrder?this.options.sortOrder:"desc",this.showActive=this.options.showActive,this.showCompleted=this.options.showCompleted,this.hidePercentage=this.options.hidePercentage},onViewReady:function(){this.columns=[{title:"Workflow",attribute:"workflowName",sortable:!0},{title:"Version",attribute:"workflowVersion",width:"100px",sortable:!0},{title:"Instance Id",attribute:"shortWorkflowInstanceId",width:"300px",sortable:!0}],this.showActive&&this.columns.push({title:"Start Time",attribute:"startTime",width:"150px",sortable:!0}),this.showCompleted&&this.columns.push({title:"End Time",attribute:"endTime",width:"150px",sortable:!0}),this.options.hidePercentage||this.columns.push({title:"Percentage Complete",attribute:"progressPercentage",width:"160px",cellType:a}),this.table=new s({plugins:[new f({selectableRows:!0,multiselect:!0}),new u,new d({topOffset:34}),new w],selectableRows:!0,columns:this.columns}),this.renderInstanceTable(),this.table.addEventHandler("sort",function(t,e){this.table.setData(this.getSortedData(t,e))}.bind(this)),this.table.addEventHandler("rowclick",function(t,e,n){var s=new r(e.attributes),i="workflowinstancen/"+e.getAttribute("workflowDefinitionId")+"/"+e.getAttribute("workflowName").match("(\\.\\s)*(.*)")[2]+"/"+e.getAttribute("shortWorkflowInstanceId")+"/"+e.getAttribute("startTime")+"/"+e.getAttribute("workflowVersion");s.setLocation(i,!1),s.start()}.bind(this))},getSortedData:function(t,e){return this.tableInstances.sort(e,t),this.tableInstances.toJSON()},subscribeForPushEvents:function(t){this.regionEventBus=t,this.regionEventBus.subscribe("instance-event",function(t){this.handlePushEvent(t)}.bind(this))},handlePushEvent:function(t){setTimeout(function(){this.renderInstanceTable()}.bind(this),2e3)},refresh:function(t){this.limit=t.limit,this.offset=t.offset,this.renderInstanceTable()},renderInstanceTable:function(){i.getDefinitionNames({success:function(t){var n=this.getProcessDefinitionId();this.workflowDefinitions={},t.each(function(t){this.workflowDefinitions[t.getAttribute("id")]=t}.bind(this)),o.getInstances2({workflowDefinitionId:n,success:function(t){this.tableInstances=new e.Collection,t.each(function(t){var n=new e.Model,s=t.getAttribute("workflowDefinitionId");n.setAttribute("workflowStatus","active"),n.setAttribute("workflowDefinitionId",s),n.setAttribute("workflowName",this.workflowDefinitions[s].getAttribute("name")),n.setAttribute("workflowVersion",this.workflowDefinitions[s].getAttribute("version")),n.setAttribute("shortWorkflowInstanceId",t.getAttribute("id")),n.setAttribute("startTime",t.getAttribute("startTime")),n.setAttribute("progressPercentage",t.getAttribute("progressPercentage")),n.setAttribute("workflowInstanceId",t.getAttribute("id")),n.setAttribute("superProcessInstanceId",t.getAttribute("superProcessInstanceId")),this.tableInstances.addModel(n)}.bind(this)),this.tableInstances=this.arrangeHierarchically(this.tableInstances),this.table.setData(this.tableInstances);var n="parent",s=!0;for(var i in this.table.getRows()){var o=this.table.getRows()[i].options.data.getAttribute("workflowName");n=-1!=o.indexOf(". . . ")?"child":"parent","parent"===n&&(s=!s),s&&this.table.getRows()[i].getElement().setStyle("background-color","#f2f2f2")}this.table.attachTo(this.getElement())}.bind(this)}),this.highlightedRow=null,this.table.addEventHandler("rowclick",function(t,e){t.isHighlighted()?(t.highlight(!1),this.highlightedRow=null,this.getEventBus().publish("instance-deselected",t.getData().attributes)):(null!=this.highlightedRow&&(this.highlightedRow.highlight(!1),this.getEventBus().publish("instance-deselected",this.highlightedRow.getData().attributes),this.highlightedRow=null),t.highlight(!0),this.highlightedRow=t,this.getEventBus().publish("instance-selected",{workflowDefinitionId:e.getAttribute("workflowDefinitionId"),workflowInstanceId:e.getAttribute("workflowInstanceId"),workflowName:e.getAttribute("workflowName").match("(\\.\\s)*(.*)")[2]}))}.bind(this))}.bind(this)})},getEventBus:function(){return this.table.getEventBus()},getProcessDefinitionId:function(){var t=window.location.hash,e=t.substring(t.indexOf("/")+1).split("/");return e[0]},getInstanceName:function(){var t=window.location.hash,e=t.substring(t.indexOf("/")+1).split("/");return e[1]},arrangeHierarchically:function(t){var n=!0,s=t,i=new e.Collection;return s.each(function(t){var e=s.searchMap(t.get("workflowInstanceId"),["superProcessInstanceId"]);e.size()?(i.addModel(t),e.each(function(e){0==s.searchMap(t.get("superProcessInstanceId"),["workflowInstanceId"]).size()?e.setAttribute("workflowName",". . . ".concat(e.getAttribute("workflowName"))):e.setAttribute("workflowName",". . . . . . ".concat(e.getAttribute("workflowName")))}),i.addModel(e._collection.models)):0==s.searchMap(t.get("superProcessInstanceId"),["workflowInstanceId"]).size()&&i.addModel(t),n=!n}),i}.bind(this)})});