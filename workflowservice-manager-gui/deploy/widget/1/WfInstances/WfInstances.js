/* Copyright (c) Ericsson 2015 */

define("widget/WfInstances/WfInstances",["jscore/core","widgets/SelectBox","widgets/Pagination","../WfProgress/WfProgress","./WfInstancesTable/WfInstancesTable","./WfInstancesView","3pps/wfs/WfInstanceClient","../WfUsertasks/TaskForm/TaskForm"],function(e,i,s,t,n,o,r,h){return e.Widget.extend({View:o,onViewReady:function(){this.regionEventBus=this.options.regionContext.eventBus,this.refreshButtonVisible=null!=this.options.refreshButtonVisible?this.options.refreshButtonVisible:!0,this.filterValueActive=null!=this.options.filterValueActive?this.options.filterValueActive:!0,this.allowPagination=null!=this.options.allowPagination?this.options.allowPagination:!1,this.showingProgress=null!=this.options.showingProgress?this.options.showingProgress:!0,this.showingDiagram=null!=this.options.showingDiagram?this.options.showingDiagram:!0,this.regionEventBus.subscribe("progress-refresh",function(e){e.subProcessId?this.progressIds.subProcessId=e.subProcessId:e.childExecutionId?(this.progressIds.childExecutionId=e.childExecutionId,this.progressIds.childDefinitionId=e.childDefinitionId):(this.progressIds.workflowInstanceId=e.workflowInstanceId,this.progressIds.workflowDefinitionId=e.workflowDefinitionId),this.hideProgress(),this.showProgress(this.progressIds,e.showingDiagram&&e.showingDiagram===!0?!0:!1)}.bind(this)),1==this.filterValueActive?this.filterValue={name:"Active",value:{liveView:!1,historicView:!1}}:this.filterValue={name:"Historic",value:{liveView:!1,historicView:!0}},this.selectBox=new i({value:this.filterValue,items:[{name:"Active",value:{liveView:!1,historicView:!1},title:"View all active workflow instances"},{name:"Active Live (Last 20)",value:{liveView:!0,historicView:!1},title:"View the 20 most recently started workflow instances"},{name:"Historic",value:{liveView:!1,historicView:!0},title:"View all completed workflow instances"},{name:"Historic Live (Last 20)",value:{liveView:!0,historicView:!0},title:"View the 20 most recently completed workflow instances"}]}),this.selectBox.attachTo(this.view.getSectionHeadingFilter()),this.selectBox.addEventHandler("change",function(){this.selectBoxChanged()}.bind(this)),this.view.getRefreshButton().addEventHandler("click",function(){this.trigger("updateServiceCall","update"),this.refreshButtonClicked(),this.regionEventBus.publish("instanceTable-refreshed","refresh")}.bind(this)),this.view.getRefreshButton().setStyle("visibility",1==this.refreshButtonVisible?"visible":"hidden"),this.showTable()},update:function(){this.trigger("updateServiceCall","update"),this.refreshButtonClicked(),this.regionEventBus.publish("refreshCounters","refreshCounters"),this.regionEventBus.publish("instanceTable-refreshed","refresh")},selectBoxChanged:function(){this.hidePagination(),this.showTable(),!this.getFilterValue().liveView&&this.allowPagination&&this.showPagination()},showTable:function(){this.hideTable(),this.WfInstancesTable=new n({offset:0,limit:this.getPageLimit(),sortBy:this.getFilterValue().historicView?"endTime":"startTime",sortOrder:"desc",showActive:this.getFilterValue().historicView?!1:!0,showCompleted:this.getFilterValue().historicView?!0:!1,hidePercentage:this.options.hidePercentage,regionEventBus:this.options.regionEventBus}),this.getFilterValue().liveView&&this.WfInstancesTable.subscribeForPushEvents(this.regionEventBus),this.WfInstancesTable.attachTo(this.view.getTableContent()),this.tableContentHeight&&this.view.getTableContent().setStyle("height","auto"),this.rowSelectionHandle(),this.selectBox.disable()},rowSelectionHandle:function(){this.WfInstancesTable.getEventBus().subscribe("instance-selected",function(e){this.progressIds=e,this.regionEventBus.publish("instance-selected",e),this.showingProgress&&this.showProgress(e),this.showingDiagram&&this.WfProgress.showDiagram()}.bind(this)),this.WfInstancesTable.getEventBus().subscribe("instance-deselected",function(e){this.progressIds=e,this.regionEventBus.publish("instance-deselected",e),this.showingProgress&&this.WfProgress.hideDiagram(),this.showingDiagram&&this.hideProgress()}.bind(this))},refreshButtonClicked:function(){this.showTable(),this.regionEventBus.publish("refreshCounters","refreshCounters"),null!=this.WfProgress&&this.WfProgress.hideDiagram(),this.hideProgress()},hideTable:function(){null!=this.WfInstancesTable&&(this.tableContentHeight=this.view.getTableContent().getStyle("height"),this.WfInstancesTable.destroy(),this.WfInstancesTable=null,this.view.getTableContent().setStyle("height","0px"))},showPagination:function(){this.hidePagination(),r.getInstancesCount({processDefinitionId:processDefinitionId,active:this.getFilterValue().historicView?!1:!0,completed:this.getFilterValue().historicView?!0:!1,success:function(e){var i=Math.ceil(e/this.getPageLimit());this.pagination=new s({pages:i,onPageChange:function(e){var i=(e-1)*this.getPageLimit();this.WfInstancesTable.refresh({offset:i,limit:this.getPageLimit()})}.bind(this)}),this.pagination.attachTo(this.view.getPagination())}.bind(this)})},hidePagination:function(){null!=this.pagination&&(this.pagination.destroy(),this.pagination=null)},showProgress:function(e,i){this.hideProgress(),this.WfProgress=new t({regionEventBus:this.regionEventBus,ids:e,showingDiagram:i,doneCallback:this.progressClosed.bind(this)}),this.regionEventBus.publish("display-progress",["progress",this.WfProgress]),e.hasOwnProperty("childExecutionId")&&this.showExtra("Showing progress for child Id: "+e.childExecutionId.substring(0,8))},progressClosed:function(){this.progressIds.hasOwnProperty("childExecutionId")||this.progressIds.hasOwnProperty("subProcessId")?(delete this.progressIds.childExecutionId,delete this.progressIds.childDefinitionId,delete this.progressIds.subProcessId,this.hideProgress(),this.showProgress(this.progressIds,!1)):(this.hideProgress(),this.selectBox.enable(),this.showTable(),!this.getFilterValue().liveView&&this.allowPagination&&this.showPagination())},hideProgress:function(){null!=this.WfProgress&&(this.WfProgress.destroy(),this.WfProgress=null)},getPageLimit:function(){return this.getFilterValue().liveView?20:500},getFilterValue:function(){return this.selectBox.getValue().value},getProcessDefinitionId:function(){var e=window.location.hash,i=e.substring(e.indexOf("/")+1).split("/");return i[0]}})});