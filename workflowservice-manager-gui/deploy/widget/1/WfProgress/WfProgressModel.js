/* Copyright (c) Ericsson 2015 */

define("widget/WfProgress/WfProgressModel",["jscore/core","jscore/ext/mvp","jscore/ext/net","3pps/wfs/WfDefinitionClient","3pps/wfs/WfProgressClient"],function(n,e,t,r,o){var a={};return a.build=function(n){var e=function(n){for(var e=Object.create(null),t=0;t<n.length;t++)e[n[t].nodeId]=n[t];return e},t=function(n){if(null!=n.annotations&&n.annotations.length>0)for(var e=0;e<n.annotations.length;e++)if("prg"===n.annotations[e])return!0;return!1},a=function(n){var e=null;if(null!=n.annotations&&n.annotations.length>0)for(var t=0;t<n.annotations.length;t++){var r=n.annotations[t].match("^p([0-9]+)");if(null!=r&&r.length>1){var o=parseInt(r[1]);0>o&&(o=0),o>100&&(o=100),e={percent:o};break}}return e},l=function(n){for(var e=!1,t=0;t<n.boundaryEvents.length;t++){var r=n.boundaryEvents[t];if("boundaryError"===r.type){e=""!=c(r);break}}return e},s=function(n){var e=i(n);return null!=e&&""!=c(e)},i=function(n){for(var e=0;e<n.boundaryEvents.length;e++){var t=n.boundaryEvents[e];if("compensationBoundaryCatch"===t.type&&1==t.assocFlowNodes.length)return t.assocFlowNodes[0]}},u=function(n){var e=0;if(null!=g[n.id])for(var t=g[n.id].events,r=0;r<t.length;r++)"end"==t[r].type&&e++;return e},c=function(n){var e=null;if(null!=g[n.id])if(l(n,g))e="Failed";else{for(var t=g[n.id].events,r=0,o=0,s=0,i=0;i<t.length;i++){var u=t[i];"start"==u.type&&r++,"end"==u.type&&o++,"call"==u.type&&(s++,n.eventData=u.eventData,b.push({activityName:n.name,childDefinitionId:u.eventData.childDefinitionId,childExecutionId:u.eventData.childExecutionId}))}if(r==o){e="Completed";var c=a(n);null!=c&&c.percent>w&&(w=c.percent)}else r>o&&(e=1==n.forCompensation?"Completed":"Started")}return null!=e?e:""},f=function(n){for(var e=n.flowNodes,r=0;r<e.length;r++){var o=e[r];if(t(o)){o.showProgress=!0;var a=c(o);o.progressStatus=a,p[o.id]=a,s(o)&&(o.compensationHandler=i(o),p[o.compensationHandler.id]=c(o.compensationHandler)),o.executionCount=u(o),h[o.id]=o.executionCount}for(var l=0;l<o.boundaryEvents.length;l++){var d=o.boundaryEvents[l];t(d)&&"boundaryError"===d.type&&null!=g[d.id]&&(p[d.id]="Failed");for(var v=0;v<d.flows.length;v++)o.flows.push(d.flows[v])}for(var l=0;l<o.flows.length;l++){var w=o.flows[l];f(w)}}};if(n=n||{},null==n.success)throw new Error("success callback missing");var d=n.workflowDefinitionId,v=n.workflowInstanceId,g=null,p=Object.create(null),h=Object.create(null),w=-1,b=[];r.getStructure({wfDefinitionId:d,success:function(t){o.getProgress({wfInstanceId:v,success:function(r){var o=t.getAttribute("flows"),a=r.getAttribute("nodeProgresses");g=e(a),f(o[0]),n.success.call(this,{wfStructureModel:t,wfProgressModel:r,keyableStatus:p,keyableCount:h,percentComplete:w>-1?w:null,calledWorkflows:b})},error:function(n){console.log(n)}})},error:function(n){console.log(n)}})},a});