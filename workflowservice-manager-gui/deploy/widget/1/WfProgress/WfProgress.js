/* Copyright (c) Ericsson 2015 */

define("styles!widget/WfProgress/WfProgress.less",function(){return".eaNFE_automation_UI-WfProgress-Buttons {\n  float: right;\n}\n.eaNFE_automation_UI-WfProgress-buttonClose {\n  min-width: 26px;\n  width: 26px;\n}\n.eaNFE_automation_UI-WfProgress-buttonDiagram {\n  min-width: 30px;\n  width: 30px;\n}\n.eaNFE_automation_UI-WfProgress-content {\n  white-space: nowrap;\n}\n.eaNFE_automation_UI-WfProgress-donut {\n  vertical-align: bottom;\n}\n.eaNFE_automation_UI-WfProgress-badge {\n  border-radius: 2em;\n  display: inline-block;\n  line-height: 1;\n  padding: 3px 5px 2px 5px;\n  text-align: center;\n}\n.eaNFE_automation_UI-WfProgress-List-top {\n  padding-left: 0px;\n}\n.eaNFE_automation_UI-WfProgress-List {\n  margin-left: 10px;\n  padding-left: 10px;\n}\n.eaNFE_automation_UI-WfProgress-List-content {\n  vertical-align: top;\n  text-align: left;\n}\n.eaNFE_automation_UI-WfProgress-List-item_default {\n  color: #cccccc;\n  font-weight: bold;\n  padding-left: 0.4rem;\n  min-height: 1.8rem;\n  line-height: 1.8rem;\n  white-space: nowrap;\n  text-overflow: ellipsis;\n  overflow: hidden;\n}\n.eaNFE_automation_UI-WfProgress-List-item_prefix {\n  color: #999999;\n  font-weight: bold;\n  padding-left: 0.4rem;\n  min-height: 1.8rem;\n  line-height: 1.8rem;\n  white-space: nowrap;\n  text-overflow: ellipsis;\n  overflow: hidden;\n}\n.eaNFE_automation_UI-WfProgress-List-item_started {\n  color: black;\n  font-weight: bold;\n  padding-left: 0.4rem;\n  min-height: 1.8rem;\n  line-height: 1.8rem;\n  white-space: nowrap;\n  text-overflow: ellipsis;\n  overflow: hidden;\n  background-color: yellow;\n}\n.eaNFE_automation_UI-WfProgress-List-item_failed {\n  color: black;\n  font-weight: bold;\n  padding-left: 0.4rem;\n  min-height: 1.8rem;\n  line-height: 1.8rem;\n  white-space: nowrap;\n  text-overflow: ellipsis;\n  overflow: hidden;\n}\n.eaNFE_automation_UI-WfProgress-List-item_completed {\n  color: black;\n  font-weight: bold;\n  padding-left: 0.4rem;\n  min-height: 1.8rem;\n  line-height: 1.8rem;\n  white-space: nowrap;\n  text-overflow: ellipsis;\n  overflow: hidden;\n}\n"}),define("text!widget/WfProgress/WfProgress.html",function(){return'<div class="eaNFE_automation_UI-WfProgress"><h3>Task Progress</h3>\r\n	<div class="eaNFE_automation_UI-WfProgress-Buttons">\r\n		<button class="ebBtn ebBtn_small eaNFE_automation_UI-WfProgress-buttonDiagram"><i class="ebIcon ebIcon_search"></i></button>\r\n		<button class="ebBtn ebBtn_small eaNFE_automation_UI-WfProgress-buttonClose"><i class="ebIcon ebIcon_close"></i></button>\r\n	</div>\r\n    <div class="eaNFE_automation_UI-WfProgress-content"></div>\r\n</div>\r\n'}),define("widget/WfProgress/WfProgressView",["jscore/core","text!./WfProgress.html","styles!./WfProgress.less"],function(e,t,s){return e.View.extend({getTemplate:function(){return t},getStyle:function(){return s},getProgressCloseButton:function(){return this.getElement().find(".eaNFE_automation_UI-WfProgress-buttonClose")},getProgressDiagramButton:function(){return this.getElement().find(".eaNFE_automation_UI-WfProgress-buttonDiagram")},getProgressContent:function(){return this.getElement().find(".eaNFE_automation_UI-WfProgress-content")}})}),define("widget/WfProgress/WfProgress",["jscore/core","jscore/ext/mvp","jscore/ext/net","widgets/Tooltip","chartlib/widgets/DonutChart","3pps/wfs/WfDefinitionClient","3pps/wfs/WfProgressClient","./WfProgressModel","./WfProgressDiagram/WfProgressDiagram","./WfProgressView"],function(e,t,s,n,o,r,i,a,l,f){return e.Widget.extend({View:f,onViewReady:function(){this.handleOptions(),a.build({workflowDefinitionId:this.workflowDefinitionId,workflowInstanceId:this.workflowInstanceId,success:function(e){this.wfStructureModel=e.wfStructureModel,this.wfProgressModel=e.wfProgressModel,this.keyableStatus=e.keyableStatus,this.percentComplete=e.percentComplete,this.calledWorkflows=e.calledWorkflows,this.renderProgress(this.regionEventBus),this.progressEventChannel=this.regionEventBus.subscribe("progress-event",function(e){this.handlePushEvent(e)}.bind(this))}.bind(this),error:function(e){console.log(e)}.bind(this)})},handleOptions:function(){this.regionEventBus=this.options.regionEventBus,this.workflowDefinitionId=this.options.ids.workflowDefinitionId,this.workflowName=this.options.ids.workflowName,this.workflowInstanceId=this.options.ids.workflowInstanceId,this.options.ids.hasOwnProperty("childExecutionId")&&(this.workflowInstanceId=this.options.ids.childExecutionId,this.workflowDefinitionId=this.options.ids.childDefinitionId),this.options.ids.hasOwnProperty("subProcessId")&&(this.subProcessId=this.options.ids.subProcessId)},renderProgress:function(t){prglistRenderCallActProgress=function(e,s){t.publish("progress-refresh",{childExecutionId:e,childDefinitionId:s})},prglistRenderSubprocessProgress=function(e){t.publish("progress-refresh",{subProcessId:e})};var s=function(e,t){var s="",n="",o="eaNFE_automation_UI-WfProgress-List-item_default ";"Started"===t?(o="eaNFE_automation_UI-WfProgress-List-item_started ",n+="<span class='eaNFE_automation_UI-WfProgress-List-item_prefix'>In Progress:&nbsp&nbsp</span>"):"Completed"===t?(o="eaNFE_automation_UI-WfProgress-List-item_completed ",s="<i class='ebIcon ebIcon_small ebIcon_tick'></i>&nbsp&nbsp"):"Failed"===t&&(o="eaNFE_automation_UI-WfProgress-List-item_failed",s="<i class='ebIcon ebIcon_small ebIcon_error'></i>&nbsp&nbsp"),e.hasOwnProperty("eventData")&&(n+="<a href='#'  class='ebBreadcrumbs-link' onclick=\"prglistRenderCallActProgress('"+e.eventData.childExecutionId+"','"+e.eventData.childDefinitionId+"')\">");var r="<span class="+o+">"+e.name+"</span>";if((e.executionCount>1||1==e.executionCount&&"Started"===t)&&(r+="&nbsp&nbsp<span class='ebBgColor_grey_20 ebColor_white eaNFE_automation_UI-WfProgress-badge'>"+e.executionCount+"</span>"),e.compensationHandler){var i="&nbsp&nbsp<i class='ebIcon ebIcon_small ebIcon_prevArrow'></i>";r+=i+"<span class="+o+">"+e.compensationHandler.name+"</span>"}return e.hasOwnProperty("eventData")&&(r+="&nbsp&nbsp<i class='ebIcon ebIcon_medium ebIcon_externalApp'></i>",r+="</a>"),"subProcess"===e.type&&(n=n+"<a href='#'  class='ebBreadcrumbs-link' onclick=\"prglistRenderSubprocessProgress('"+e.id+"')\">",r+="&nbsp&nbsp<i class='ebIcon ebIcon_medium ebIcon_externalApp'></i>",r+="</a>"),"<li class='"+o+"'>"+s+n+r+"</li>"},n=function(e,t){for(var s=0;s<e.flowNodes.length;s++){var o=e.flowNodes[s];if(o.id===t)return o;for(var r=0;r<o.flows.length;r++){var i=n(o.flows[r],t);if(null!=i)return i}}},o=function(e){for(var t="",n=!1,r=e.flowNodes,i=0;i<r.length;i++){var a=r[i];a.showProgress&&1==a.showProgress&&(null!=a.progressStatus&&""!=a.progressStatus&&(n=!0),t+=s(a,a.progressStatus));for(var l=0;l<a.flows.length;l++){var d=a.flows[l];innerResult=o(d),t+=f,t+=s(d,innerResult.hasActivity?"Completed":""),t+=f,t+=innerResult.html,t+="</ul>",t+="</ul>"}}return{html:t,hasActivity:n}},r=this.wfStructureModel.getAttribute("flows"),i=r[0];if(this.subProcessId){var a=n(i,this.subProcessId);i={flowNodes:a.assocFlowNodes}}var l="<table>";l+="<tr>",l+="<td class='eaNFE_automation_UI-WfProgress-donut'>",l+="</td>",l+="<td class='eaNFE_automation_UI-WfProgress-List-content'>",l+="<ul class='eaNFE_automation_UI-WfProgress-List-top'>";var f="<ul class='eaNFE_automation_UI-WfProgress-List'>";i=o(i),l+=i.html,l+="</ul>",l+="</td>",l+="</tr>",l+="</table>",this.progressElement=e.Element.parse(l),this.view.getProgressContent().append(this.progressElement)},showDiagram:function(){this.progressDiagram&&null!=this.progressDiagram&&this.progressDiagram.destroy(),this.progressDiagram=new l(this.options),this.regionEventBus.publish("display-element",["ProgressDiagram",this.progressDiagram])},hideDiagram:function(){this.progressDiagram.destroy()},handlePushEvent:function(e){e.workflowInstanceId==this.workflowInstanceId&&(this.refreshRequested||setTimeout(function(){this.regionEventBus.publish("progress-refresh",{workflowInstanceId:this.workflowInstanceId,workflowDefinitionId:this.workflowDefinitionId})}.bind(this),1e3),this.refreshRequested=!0)}})});