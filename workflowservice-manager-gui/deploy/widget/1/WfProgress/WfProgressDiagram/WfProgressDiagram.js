/* Copyright (c) Ericsson 2015 */

define("styles!widget/WfProgress/WfProgressDiagram/WfProgressDiagram.less",function(){return".eaNFE_automation_UI-WfProgressDiagram-buttonBack {\n  min-width: 26px;\n  width: 26px;\n  visibility: visible;\n}\n.eaNFE_automation_UI-WfProgressDiagram-contentCalled {\n  padding-top: 6px;\n}\n.eaNFE_automation_UI-WfProgressDiagram-calledInstance {\n  padding-left: 10px;\n}\n"}),define("text!widget/WfProgress/WfProgressDiagram/WfProgressDiagram.html",function(){return'<div class="eaNFE_automation_UI-WfProgressDiagram">\r\n	<table>\r\n		<tr>\r\n			<td valign="top">\r\n				<div class="eaNFE_automation_UI-WfProgressDiagram-Buttons">\r\n					<button class="ebBtn ebBtn_small eaNFE_automation_UI-WfProgressDiagram-buttonBack"><i class="ebIcon ebIcon_prevArrow"></i></button>\r\n				</div>\r\n			</td>			\r\n			<td valign="top">\r\n				<div class="eaNFE_automation_UI-WfProgressDiagram-contentCalled"></div>\r\n    			<div class="eaNFE_automation_UI-WfProgressDiagram-contentDiagram"></div>\r\n    		</td>\r\n    		<td valign="top">\r\n			</td>\r\n    	</tr>\r\n    </table>\r\n</div>\r\n'}),define("widget/WfProgress/WfProgressDiagram/WfProgressDiagramView",["jscore/core","text!./WfProgressDiagram.html","styles!./WfProgressDiagram.less"],function(t,e,i){return t.View.extend({getTemplate:function(){return e},getStyle:function(){return i},getBackButton:function(){return this.getElement().find(".eaNFE_automation_UI-WfProgressDiagram-buttonBack")},getCalledContent:function(){return this.getElement().find(".eaNFE_automation_UI-WfProgressDiagram-contentCalled")},getDiagramContent:function(){return this.getElement().find(".eaNFE_automation_UI-WfProgressDiagram-contentDiagram")}})}),define("widget/WfProgress/WfProgressDiagram/WfProgressDiagram",["jscore/core","widgets/Tooltip","../WfProgressModel","../../WfDiagram/WfDiagram","./WfProgressDiagramView"],function(t,e,i,n,s){return t.Widget.extend({View:s,onViewReady:function(){this.handleOptions(),this.subscribeForEvents(),this.setupBackButton(),this.hideBackButton(),this.activeWorkflowDefinitionId=this.workflowDefinitionId,this.activeWorkflowInstanceId=this.workflowInstanceId,this.showingChild=!1},handleOptions:function(){this.regionEventBus=this.options.regionEventBus,this.workflowDefinitionId=this.options.ids.workflowDefinitionId,this.workflowName=this.options.ids.workflowName,this.workflowInstanceId=this.options.ids.workflowInstanceId},subscribeForEvents:function(){this.progressEventChannel=this.regionEventBus.subscribe("progress-event",function(t){this.handlePushEvent(t)}.bind(this))},unsubscribeForEvents:function(){hasOwnProperty("progressEventChannel")&&this.regionEventBus.unsubscribe("progress-event",this.progressEventChannel),delete this.progressEventChannel},setupBackButton:function(){var t=this.view.getBackButton();t.addEventHandler("click",function(t){1==this.showingChild&&(this.activeWorkflowDefinitionId=this.workflowDefinitionId,this.activeWorkflowInstanceId=this.workflowInstanceId,this.showingChild=!1,this.hideBackButton(),this.redrawDiagram())}.bind(this),this);var i=new e({parent:t,enabled:!0,contentText:"Back to parent",modifiers:[{name:"size",value:"large"}]});i.attachTo(this.getElement())},showBackButton:function(){this.view.getBackButton().setStyle("visibility","visible")},hideBackButton:function(){this.view.getBackButton().setStyle("visibility","hidden")},showDiagram:function(){i.build({workflowDefinitionId:this.activeWorkflowDefinitionId,workflowInstanceId:this.activeWorkflowInstanceId,success:function(t){this.wfStructureModel=t.wfStructureModel,this.wfProgressModel=t.wfProgressModel,this.keyableStatus=t.keyableStatus,this.keyableCount=t.keyableCount,this.percentComplete=t.percentComplete,this.calledWorkflows=t.calledWorkflows;var e=this.buildOverlays(this.keyableStatus,this.keyableCount);this.bpmnDiagram=new n({xid:"prg-",wfDefinitionId:this.activeWorkflowDefinitionId,wfName:this.workflowName,highlights:e.highlights,countBadges:e.countBadges}),this.bpmnDiagram.attachTo(this.view.getDiagramContent()),this.addCalledWorkflows()}.bind(this),error:function(t){console.log(t)}.bind(this)})},buildOverlays:function(t,e){var i=[],n=[];for(var s in t){var o=t[s];if(o&&null!=o&&""!==o){i.push({nodeId:s,style:"highlight-"+o});var a=e[s];a&&a>0&&(a>1||1==a&&"Started"===o)&&n.push({nodeId:s,count:a})}}return{highlights:i,countBadges:n}},addCalledWorkflows:function(){if(prgdiagRenderCallActProgress=function(t,e){if(1==this.showingChild)throw"Only one level of call activity supported";this.activeWorkflowDefinitionId=e,this.activeWorkflowInstanceId=t,this.showingChild=!0,this.showBackButton(),this.view.getCalledContent().children()[0].remove(),this.redrawDiagram()}.bind(this),this.calledWorkflows.length>0){var e="<table><tr>";e+="<td>Called workflow instances: </td>";for(var i=0;i<this.calledWorkflows.length;i++){var n=this.calledWorkflows[i];e+="<td class='eaNFE_automation_UI-WfProgressDiagram-calledInstance'>",e+="<a href='#'  class='ebBreadcrumbs-link' onclick=\"prgdiagRenderCallActProgress('"+n.childExecutionId+"','"+n.childDefinitionId+"')\">",e+=n.activityName,e+="</a>",e+="</td>"}e+="</tr></table>",calledElement=t.Element.parse(e);var s=this.view.getCalledContent(),o=s.children();0!=o.length&&o[0].remove(),s.append(calledElement)}},redrawDiagram:function(){this.hasOwnProperty("bpmnDiagram")&&(this.bpmnDiagram.destroy(),delete this.bpmnDiagram,this.showDiagram())},updateProgress:function(){i.build({workflowDefinitionId:this.activeWorkflowDefinitionId,workflowInstanceId:this.activeWorkflowInstanceId,success:function(t){this.keyableStatus=t.keyableStatus,this.keyableCount=t.keyableCount,this.percentComplete=t.percentComplete,this.calledWorkflows=t.calledWorkflows;var e=this.buildOverlays(this.keyableStatus,this.keyableCount);this.bpmnDiagram.setHighlights(e.highlights),this.bpmnDiagram.setCountBadges(e.countBadges),this.addCalledWorkflows()}.bind(this),error:function(t){console.log(t)}.bind(this)})},handlePushEvent:function(t){t.workflowInstanceId==this.activeWorkflowInstanceId&&setTimeout(function(){this.updateProgress()}.bind(this),1e3)}})});